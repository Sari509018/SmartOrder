<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>הזמנות</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo&display=swap" rel="stylesheet" />
  <style>
    body {
      direction: rtl;
      font-family: 'Heebo', sans-serif;
      padding: 20px;
      background-color: #f7f7f7;
      margin: 0;
      display: flex;
      gap: 30px;
    }

    #products {
      flex: 3;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
      width: 100%;
    }

    .category {
      margin-bottom: 40px;
    }

    .category h3 {
      border-bottom: 2px solid #ccc;
      padding-bottom: 10px;
      margin-bottom: 20px;
      color: #444;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    .product {
      background-color: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
      transition: transform 0.2s ease;
    }

    .product:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }

    .product img {
      max-width: 100%;
      max-height: 180px;
      object-fit: contain;
      border-radius: 10px;
      margin-bottom: 12px;
    }

    .product strong {
      font-size: 1.1rem;
      color: #222;
      margin-bottom: 8px;
      display: block;
    }

    .quantity {
      color: #555;
      font-size: 0.95rem;
      margin-bottom: 10px;
    }

    input[type=number] {
      font-family: 'Heebo', sans-serif;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 100px;
      text-align: center;
      direction: ltr;
    }

    .clear-btn, .pay-btn {
      display: block;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 10px;
      width: 100%;
    }

    .clear-btn {
      background-color: #d9534f;
    }

    .clear-btn:hover {
      background-color: #c9302c;
    }

    .pay-btn:hover {
      background-color: #0056b3;
    }

    #order-section {
      background-color: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 250px;
    }

    #summary h3 {
      margin-top: 0;
      color: #333;
    }

    #summary ul {
      list-style: none;
      padding: 0;
      margin: 0 0 10px 0;
    }

    #summary li.cart-item {
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 10px;
      margin-bottom: 10px;
      background-color: #f9f9f9;
    }

    #total {
      font-weight: bold;
      color: #222;
      font-size: 1.1rem;
      margin-top: 10px;
    }

    #summary .empty {
      color: #777;
      text-align: center;
      padding: 10px;
    }

    @media (max-width: 900px) {
      body {
        flex-direction: column;
      }

      .products-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .products-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h2>המוצרים שלנו</h2>
  <div id="products">טוען...</div>

  <div id="order-section">
    <button class="clear-btn" onclick="clearOrder()">נקה הזמנה</button>
    <div id="summary">
      <h3>סיכום הזמנה</h3>
      <ul id="order-list"></ul>
      <div id="total"></div>
      <button class="pay-btn" onclick="goToPayment()">המשך לתשלום</button>
    </div>
  </div>

  <script>
    const apiKey = "YOUR_API_KEY";
    const baseId = "YOUR_BASE_ID";
    const tableName = "קטלוג";

    function clearOrder() {
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith("order-")) {
          localStorage.removeItem(key);
        }
      });
      location.reload();
    }

    function goToPayment() {
      alert("מעבר לדף תשלום (החלף בקישור אמיתי)");
    }

    function updateOrderSummary(records) {
      const summaryItems = [];
      let total = 0;

      records.forEach(record => {
        const code = record.fields["קוד מוצר"];
        const name = record.fields["שם מוצר"];
        const quantity = Number(localStorage.getItem(`order-${code}`)) || 0;
        const price = Number(record.fields["מחיר"]) || 0;

        if (quantity > 0) {
          const itemTotal = quantity * price;
          summaryItems.push(`<li class="cart-item">${name} — כמות: ${quantity}, מחיר ליחידה: ${price} ₪, סה"כ: ${itemTotal} ₪</li>`);
          total += itemTotal;
        }
      });

      const orderList = document.getElementById("order-list");
      const totalDisplay = document.getElementById("total");

      if (summaryItems.length > 0) {
        orderList.innerHTML = summaryItems.join("");
        totalDisplay.textContent = `סה"כ לתשלום: ${total} ₪`;
      } else {
        orderList.innerHTML = `<p class="empty">הסל ריק.</p>`;
        totalDisplay.textContent = "";
      }
    }

    fetch(`https://api.airtable.com/v0/${baseId}/${tableName}?sort[0][field]=קוד מוצר&sort[0][direction]=asc`, {
      headers: { Authorization: `Bearer ${apiKey}` }
    })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("products");
        container.innerHTML = "";

        const groups = {};
        data.records.forEach(record => {
          const category = record.fields["מחלקה"] || "שונות";
          if (!groups[category]) groups[category] = [];
          groups[category].push(record);
        });

        Object.keys(groups).forEach(category => {
          const categoryDiv = document.createElement("div");
          categoryDiv.className = "category";
          const title = document.createElement("h3");
          title.textContent = category;
          categoryDiv.appendChild(title);

          const grid = document.createElement("div");
          grid.className = "products-grid";

          groups[category].forEach(record => {
            const name = record.fields["שם מוצר"];
            const code = record.fields["קוד מוצר"];
            const details = record.fields["תיאור מוצר"] || "";
            const quantity = record.fields["כמות במלאי"] || 0;
            const price = record.fields["מחיר"] || 0;
            const img = record.fields["תמונה"];
            const imageUrl = img && img.length > 0 ? img[0].url : null;
            const savedQuantity = localStorage.getItem(`order-${code}`) || "0";

            const div = document.createElement("div");
            div.className = "product";

            let html = `
              ${imageUrl ? `<img src="${imageUrl}" alt="${name}">` : ''}
              <strong>${name}</strong>
              ${details ? `<p style="margin: 8px 0; color: #666; font-size: 0.95rem;">${details}</p>` : ''}
              <div class="quantity">${quantity === 0 ? "אזל מהמלאי" : ""}</div>
              <div class="price">מחיר: ${price} ₪</div>
              <label>בחר כמות להזמנה:
                <input type="number" min="0" max="${quantity}" value="${quantity === 0 ? 0 : savedQuantity}" step="1" ${quantity === 0 ? "disabled" : ""} />
              </label>
            `;

            div.innerHTML = html;
            grid.appendChild(div);

            const input = div.querySelector("input");
            if (quantity > 0) {
              input.addEventListener("change", () => {
                localStorage.setItem(`order-${code}`, input.value);
                updateOrderSummary(data.records);
              });
            }
          });

          categoryDiv.appendChild(grid);
          container.appendChild(categoryDiv);
        });

        updateOrderSummary(data.records);
      })
      .catch(err => {
        document.getElementById("products").innerText = "שגיאה בטעינת הנתונים.";
        console.error(err);
      });
  </script>
</body>
</html>
